{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (b.hasOwnProperty(p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nimport * as React from 'react';\nimport { withMap } from './context';\n\nvar Source = function (_super) {\n  __extends(Source, _super);\n\n  function Source() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.id = _this.props.id;\n\n    _this.onStyleDataChange = function () {\n      if (!_this.props.map.getLayer(_this.id)) {\n        _this.initialize();\n\n        _this.forceUpdate();\n      }\n    };\n\n    _this.initialize = function () {\n      var map = _this.props.map;\n      var _a = _this.props,\n          geoJsonSource = _a.geoJsonSource,\n          tileJsonSource = _a.tileJsonSource,\n          onSourceAdded = _a.onSourceAdded;\n\n      if (!map.getSource(_this.id) && (geoJsonSource || tileJsonSource)) {\n        if (geoJsonSource) {\n          map.addSource(_this.id, geoJsonSource);\n        } else if (tileJsonSource) {\n          map.addSource(_this.id, tileJsonSource);\n        }\n\n        map.on('sourcedata', _this.onData);\n\n        if (onSourceAdded) {\n          onSourceAdded(map.getSource(_this.id));\n        }\n      }\n    };\n\n    _this.onData = function () {\n      var map = _this.props.map;\n      var source = map.getSource(_this.props.id);\n\n      if (!source || !map.isSourceLoaded(_this.props.id)) {\n        return;\n      }\n\n      var onSourceLoaded = _this.props.onSourceLoaded;\n\n      if (source && onSourceLoaded) {\n        onSourceLoaded(source);\n      }\n\n      if (source && _this.props.geoJsonSource && _this.props.geoJsonSource.data) {\n        source.setData(_this.props.geoJsonSource.data);\n      }\n\n      map.off('sourcedata', _this.onData);\n    };\n\n    return _this;\n  }\n\n  Source.prototype.componentDidMount = function () {\n    var map = this.props.map;\n    map.on('styledata', this.onStyleDataChange);\n    this.initialize();\n  };\n\n  Source.prototype.removeSource = function () {\n    var _this = this;\n\n    var map = this.props.map;\n\n    if (map.getSource(this.id)) {\n      var _a = map.getStyle().layers,\n          layers_1 = _a === void 0 ? [] : _a;\n      layers_1 = layers_1.map(function (layer, idx) {\n        var before = (layers_1[idx + 1] || {\n          id: undefined\n        }).id;\n        return __assign({}, layer, {\n          before: before\n        });\n      }).filter(function (layer) {\n        return layer.source === _this.id;\n      });\n      layers_1.forEach(function (layer) {\n        return map.removeLayer(layer.id);\n      });\n      map.removeSource(this.id);\n      return layers_1.reverse();\n    }\n\n    return [];\n  };\n\n  Source.prototype.componentWillUnmount = function () {\n    var map = this.props.map;\n\n    if (!map || !map.getStyle()) {\n      return;\n    }\n\n    map.off('styledata', this.onStyleDataChange);\n    this.removeSource();\n  };\n\n  Source.prototype.componentDidUpdate = function (prevProps) {\n    var geoJsonSource = prevProps.geoJsonSource,\n        tileJsonSource = prevProps.tileJsonSource,\n        map = prevProps.map;\n    var source = map.getSource(this.id);\n\n    if (tileJsonSource && this.props.tileJsonSource) {\n      var urlUpdated = false;\n      var tilesUpdated = false;\n\n      if (source && source.type === 'vector') {\n        var hasNewSourceUrl = tileJsonSource.url !== this.props.tileJsonSource.url;\n\n        if (hasNewSourceUrl && this.props.tileJsonSource.url !== undefined) {\n          source.setUrl(this.props.tileJsonSource.url);\n          urlUpdated = true;\n        }\n\n        var hasNewSourceTiles = tileJsonSource.tiles !== this.props.tileJsonSource.tiles;\n\n        if (hasNewSourceTiles && this.props.tileJsonSource.tiles !== undefined) {\n          source.setTiles(this.props.tileJsonSource.tiles);\n          tilesUpdated = true;\n        }\n      }\n\n      var hasNewTilesSource = !urlUpdated && tileJsonSource.url !== this.props.tileJsonSource.url || !tilesUpdated && tileJsonSource.tiles !== this.props.tileJsonSource.tiles || tileJsonSource.minzoom !== this.props.tileJsonSource.minzoom || tileJsonSource.maxzoom !== this.props.tileJsonSource.maxzoom;\n\n      if (hasNewTilesSource) {\n        var layers = this.removeSource();\n        map.addSource(this.id, this.props.tileJsonSource);\n        layers.forEach(function (layer) {\n          return map.addLayer(layer, layer.before);\n        });\n      }\n    }\n\n    if (geoJsonSource && this.props.geoJsonSource && this.props.geoJsonSource.data !== geoJsonSource.data && this.props.geoJsonSource.data && source && source.type === 'geojson') {\n      source.setData(this.props.geoJsonSource.data);\n    }\n  };\n\n  Source.prototype.render = function () {\n    return null;\n  };\n\n  return Source;\n}(React.Component);\n\nexport { Source };\nexport default withMap(Source);","map":null,"metadata":{},"sourceType":"module"}